<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Flete por Comuna – Región Metropolitana</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: white;
  font-family: Arial, sans-serif;
}

#map {
  width: 100vw;
  height: 100vh;
}

/* ===============================
   BUSCADOR + LEYENDA
================================ */

#search-box {
  position: absolute;
  top: 15px;
  left: 15px;
  background: white;
  padding: 10px 12px;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  z-index: 1000;
  width: 230px;
}

#search-box label {
  display: block;
  font-size: 13px;
  font-weight: bold;
  margin-bottom: 4px;
}

#comuna-input {
  width: 100%;
  height: 30px;
  padding: 4px 6px;
  font-size: 14px;
  box-sizing: border-box;
}

#dropdown {
  margin-top: 4px;
  border: 1px solid #ccc;
  border-radius: 4px;
  max-height: 160px;
  overflow-y: auto;
  display: none;
  background: white;
}

.dropdown-item {
  padding: 6px;
  cursor: pointer;
  font-size: 14px;
}

.dropdown-item:hover {
  background: #f0f0f0;
}

/* ===== LEYENDA AUTOPISTA ===== */

#leyenda {
  margin-top: 10px;
  padding-top: 8px;
  border-top: 1px solid #e0e0e0;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 8px;
}

#linea-vespucio {
  width: 28px;
  height: 4px;
  background: #c00000;
  opacity: 0.7;
  border-radius: 2px;
}

/* ===============================
   INFO
================================ */

.info {
  position: absolute;
  bottom: 20px;
  left: 15px;
  background: white;
  padding: 12px 16px;
  font-size: 15px;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  z-index: 999;
}

/* ===============================
   COMUNAS + ANIMACIÓN
================================ */

.comuna {
  transition: fill-opacity 0.25s ease, stroke-width 0.25s ease;
}

.comuna-seleccionada {
  animation: pulsoBorde 1.8s ease-in-out infinite;
}

@keyframes pulsoBorde {
  0% { stroke-width: 3; }
  50% { stroke-width: 5; }
  100% { stroke-width: 3; }
}

/* ===============================
   LABEL COMUNA EN MAPA
================================ */

.leaflet-tooltip.comuna-label {
  background: rgba(255,255,255,0.9);
  border: none;
  box-shadow: 0 1px 4px rgba(0,0,0,0.3);
  font-weight: bold;
  font-size: 14px;
  padding: 4px 8px;
  border-radius: 4px;
}
</style>
</head>

<body>

<div id="search-box">
  <label>Buscar comuna</label>
  <input id="comuna-input" placeholder="Escriba una comuna">
  <div id="dropdown"></div>

  <!-- LEYENDA -->
  <div id="leyenda">
    <div id="linea-vespucio"></div>
    <div>Autopista Américo Vespucio</div>
  </div>
</div>

<div id="map"></div>

<div class="info" id="info">
  Seleccione una comuna
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const FLETE_BASE = 7000;
const ZOOM_INICIAL = 10;

const COMUNAS_ACTIVAS = [
  "Cerrillos","Cerro Navia","Conchalí","El Bosque","Estación Central",
  "Huechuraba","Independencia","La Cisterna","La Florida","La Granja",
  "La Pintana","La Reina","Lampa","Las Condes","Lo Barnechea",
  "Lo Espejo","Lo Prado","Macul","Maipú","Ñuñoa",
  "Pedro Aguirre Cerda","Peñalolén","Providencia","Pudahuel",
  "Puente Alto","Quilicura","Quinta Normal","Recoleta","Renca",
  "San Bernardo","San Joaquín","San Miguel","San Ramón",
  "Santiago","Vitacura"
];

const colores = ["#cfeeee","#fff4cc","#e6def2","#f7d6d0","#dbe9f6","#fde5cc"];

const map = L.map('map', {
  minZoom: ZOOM_INICIAL,
  maxZoom: 13
}).setView([-33.45, -70.66], ZOOM_INICIAL);

L.control.zoom({ position: 'bottomright' }).addTo(map);

let geojson, capasPorComuna = {}, comunaSeleccionada = null, labelActivo = null;

function estilo(feature) {
  return {
    fillColor: colores[feature.properties.OBJECTID % colores.length],
    weight: 0.8,
    color: "#aaa",
    fillOpacity: 0.4,
    className: "comuna"
  };
}

function seleccionar(layer, nombre) {
  if (comunaSeleccionada) comunaSeleccionada.getElement()?.classList.remove("comuna-seleccionada");
  if (labelActivo) map.removeLayer(labelActivo);

  comunaSeleccionada = layer;
  geojson.resetStyle();

  layer.setStyle({ fillOpacity: 0.85, weight: 3, color: "#000" });
  layer.getElement()?.classList.add("comuna-seleccionada");

  map.fitBounds(layer.getBounds(), { maxZoom: 12 });

  document.getElementById("info").innerHTML =
    `<strong>${nombre}</strong><br>Flete: $${FLETE_BASE.toLocaleString("es-CL")}`;

  labelActivo = L.tooltip({
    permanent: true,
    direction: "center",
    className: "comuna-label"
  })
  .setContent(nombre)
  .setLatLng(layer.getBounds().getCenter())
  .addTo(map);
}

fetch("https://services3.arcgis.com/uZrwedu11XCCdHk1/ArcGIS/rest/services/Comunas_de_la_RM/FeatureServer/1/query?where=1=1&outFields=*&f=geojson")
.then(r => r.json())
.then(data => {
  geojson = L.geoJSON(data, {
    filter: f => COMUNAS_ACTIVAS.includes(f.properties.NOM_COM),
    style: estilo,
    onEachFeature: (f,l) => {
      capasPorComuna[f.properties.NOM_COM] = l;
      l.on("click", () => seleccionar(l, f.properties.NOM_COM));
    }
  }).addTo(map);

  fetch("./data/americo_vespucio.geojson")
    .then(r => r.json())
    .then(av => {
      L.geoJSON(av, {
        style: { color:"#c00000", weight:4, opacity:0.6 }
      }).addTo(map);
    });
});

/* BUSCADOR */
const input = document.getElementById("comuna-input");
const dropdown = document.getElementById("dropdown");

input.addEventListener("input", () => {
  dropdown.innerHTML = "";
  if (!input.value) return dropdown.style.display = "none";

  COMUNAS_ACTIVAS.filter(c => c.toLowerCase().includes(input.value.toLowerCase()))
    .forEach(c => {
      const d = document.createElement("div");
      d.className = "dropdown-item";
      d.textContent = c;
      d.onclick = () => {
        input.value = c;
        dropdown.style.display = "none";
        seleccionar(capasPorComuna[c], c);
      };
      dropdown.appendChild(d);
    });

  dropdown.style.display = "block";
});
</script>

</body>
</html>
