<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa Comunas + Américo Vespucio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 6px;
      width: 260px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }

    #comunaSearch {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
    }

    #legend {
      margin-top: 10px;
      font-size: 13px;
    }

    #map {
      height: 100vh;
      width: 100vw;
    }

    /* =========================
       TOOLTIP + ANIMACIÓN
    ========================== */

    .comuna-tooltip {
      background: rgba(0,0,0,0.75);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 12px;
      box-shadow: none;

      opacity: 0;
      transform: translateY(4px);
      transition:
        opacity 0.25s ease,
        transform 0.25s ease;
      pointer-events: none;
    }

    .comuna-tooltip.visible {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>

<div id="controls">
  <input type="text" id="comunaSearch" placeholder="Buscar comuna..." list="comunasList">
  <datalist id="comunasList"></datalist>

  <div id="legend">
    <b>Leyenda</b><br>
    <span style="color:#d7191c;">━</span> Autopista Américo Vespucio
  </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const map = L.map('map').setView([-33.45, -70.65], 11);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
  }).addTo(map);

  let comunasLayer;
  let comunaIndex = {};

  function comunaStyle() {
    return {
      color: '#999',
      weight: 1,
      fillColor: '#dddddd',
      fillOpacity: 0.4
    };
  }

  function comunaHighlightStyle() {
    return {
      color: '#333',
      weight: 2,
      fillColor: '#bbbbbb',
      fillOpacity: 0.6
    };
  }

  function bindComunaInteractions(feature, layer) {
    const nombre = feature.properties.NOM_COM;

    const tooltip = layer.bindTooltip(nombre, {
      direction: 'center',
      className: 'comuna-tooltip',
      sticky: true,
      opacity: 1
    });

    layer.on({
      mouseover: (e) => {
        e.target.setStyle(comunaHighlightStyle());
        e.target.openTooltip();

        setTimeout(() => {
          const el = e.target.getTooltip()?.getElement();
          el && el.classList.add("visible");
        }, 10);
      },
      mouseout: (e) => {
        const el = e.target.getTooltip()?.getElement();
        el && el.classList.remove("visible");

        setTimeout(() => {
          comunasLayer.resetStyle(e.target);
          e.target.closeTooltip();
        }, 250);
      }
    });

    comunaIndex[nombre.toLowerCase()] = layer;

    const option = document.createElement("option");
    option.value = nombre;
    document.getElementById("comunasList").appendChild(option);
  }

  fetch('comunas_rm.geojson')
    .then(res => res.json())
    .then(data => {
      comunasLayer = L.geoJSON(data, {
        style: comunaStyle,
        onEachFeature: bindComunaInteractions
      }).addTo(map);
    });

  document.getElementById("comunaSearch").addEventListener("change", function () {
    const value = this.value.toLowerCase();

    if (comunaIndex[value]) {
      const layer = comunaIndex[value];
      map.fitBounds(layer.getBounds(), { padding: [30, 30] });

      layer.setStyle(comunaHighlightStyle());
      layer.openTooltip();

      setTimeout(() => {
        const el = layer.getTooltip()?.getElement();
        el && el.classList.add("visible");
      }, 10);

      setTimeout(() => {
        const el = layer.getTooltip()?.getElement();
        el && el.classList.remove("visible");
        comunasLayer.resetStyle(layer);
        layer.closeTooltip();
      }, 2200);
    }
  });

  fetch('americo_vespucio.geojson')
    .then(res => res.json())
    .then(data => {
      L.geoJSON(data, {
        style: {
          color: '#d7191c',
          weight: 4
        }
      }).addTo(map);
    });
</script>

</body>
</html>
