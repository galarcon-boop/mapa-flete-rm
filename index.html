<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Flete por Comuna ‚Äì Regi√≥n Metropolitana</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: white;
  font-family: Arial, sans-serif;
}

#map {
  width: 100vw;
  height: 100vh;
}

/* Buscador */
#search-box {
  position: absolute;
  top: 15px;
  left: 15px;
  background: white;
  padding: 10px 12px;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  z-index: 1000;
  width: 230px;
}

#search-box label {
  font-size: 13px;
  font-weight: bold;
}

#comuna-input {
  width: 100%;
  height: 30px;
  padding: 4px 6px;
  font-size: 14px;
}

#dropdown {
  margin-top: 4px;
  border: 1px solid #ccc;
  border-radius: 4px;
  max-height: 160px;
  overflow-y: auto;
  display: none;
  background: white;
}

.dropdown-item {
  padding: 6px;
  cursor: pointer;
}

.dropdown-item:hover {
  background: #f0f0f0;
}

/* Info */
.info {
  position: absolute;
  bottom: 20px;
  left: 15px;
  background: white;
  padding: 12px 16px;
  font-size: 15px;
  border-radius: 6px;
  border: 1px solid #ccc;
  z-index: 999;
}

/* Labels comunas */
.label-comuna {
  font-size: 11px;
  font-weight: bold;
  color: #444;
  background: rgba(255,255,255,0.7);
  padding: 1px 3px;
  border-radius: 3px;
}
</style>
</head>

<body>

<div id="search-box">
  <label>Buscar comuna</label>
  <input id="comuna-input" placeholder="Escriba una comuna">
  <div id="dropdown"></div>
</div>

<div id="map"></div>

<div class="info" id="info">Seleccione una comuna</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ===============================
   CONFIGURACI√ìN
================================ */

const FLETE_BASE = 7000;
const ZOOM_INICIAL = 10;
const ZOOM_MOSTRAR_LABELS = 12;

const COMUNAS_ACTIVAS = [
  "Cerrillos","Cerro Navia","Conchal√≠","El Bosque","Estaci√≥n Central",
  "Huechuraba","Independencia","La Cisterna","La Florida","La Granja",
  "La Pintana","La Reina","Lampa","Las Condes","Lo Barnechea",
  "Lo Espejo","Lo Prado","Macul","Maip√∫","√ëu√±oa",
  "Pedro Aguirre Cerda","Pe√±alol√©n","Providencia","Pudahuel",
  "Puente Alto","Quilicura","Quinta Normal","Recoleta","Renca",
  "San Bernardo","San Joaqu√≠n","San Miguel","San Ram√≥n",
  "Santiago","Vitacura"
];

/* üé® Colores pastel claros */
const colores = [
  "#e6f2ff","#fcefe6","#eaf7ea","#fff3cd",
  "#f2e6ff","#e6fff9","#fde6ec","#f4f4f4"
];

/* ===============================
   MAPA
================================ */

const map = L.map('map', {
  zoomControl: false,
  minZoom: ZOOM_INICIAL,
  maxZoom: 13
}).setView([-33.45, -70.66], ZOOM_INICIAL);

L.control.zoom({ position: 'bottomright' }).addTo(map);

map.setMaxBounds([
  [-34.2, -71.6],
  [-32.8, -69.9]
]);

let geojson;
let capasPorComuna = {};
let labels = [];

/* ===============================
   ESTILO COMUNAS
================================ */

function estilo(feature) {
  const index = feature.properties.OBJECTID % colores.length;
  return {
    fillColor: colores[index],
    weight: 1,
    color: "#aaa",
    fillOpacity: 0.7
  };
}

function destacar(layer) {
  geojson.resetStyle();
  layer.setStyle({
    weight: 3,
    color: "#000",
    fillOpacity: 0.9
  });
}

function mostrarInfo(nombre) {
  document.getElementById("info").innerHTML =
    `<strong>${nombre}</strong><br>Flete: $${FLETE_BASE.toLocaleString("es-CL")}`;
}

function irAComuna(nombre) {
  const layer = capasPorComuna[nombre];
  if (!layer) return;
  map.fitBounds(layer.getBounds(), { maxZoom: 12 });
  destacar(layer);
  mostrarInfo(nombre);
}

/* ===============================
   CARGA COMUNAS
================================ */

fetch("https://services3.arcgis.com/uZrwedu11XCCdHk1/ArcGIS/rest/services/Comunas_de_la_RM/FeatureServer/1/query?where=1=1&outFields=*&f=geojson")
.then(r => r.json())
.then(data => {

  geojson = L.geoJSON(data, {
    filter: f => COMUNAS_ACTIVAS.includes(
      f.properties.NOM_COM || f.properties.COMUNA || ""
    ),
    style: estilo,
    onEachFeature: (feature, layer) => {
      const nombre = feature.properties.NOM_COM || feature.properties.COMUNA;
      capasPorComuna[nombre] = layer;

      const tooltip = layer.bindTooltip(nombre, {
        permanent: true,
        direction: "center",
        className: "label-comuna"
      });

      labels.push(tooltip);
      layer.on("click", () => irAComuna(nombre));
    }
  }).addTo(map);

  map.fitBounds(geojson.getBounds());

  actualizarLabels();
});

/* ===============================
   MOSTRAR LABELS SEG√öN ZOOM
================================ */

function actualizarLabels() {
  const mostrar = map.getZoom() >= ZOOM_MOSTRAR_LABELS;
  labels.forEach(t => {
    if (mostrar) t.openTooltip();
    else t.closeTooltip();
  });
}

map.on("zoomend", actualizarLabels);

/* ===============================
   BUSCADOR
================================ */

const input = document.getElementById("comuna-input");
const dropdown = document.getElementById("dropdown");

input.addEventListener("input", () => {
  dropdown.innerHTML = "";
  const texto = input.value.toLowerCase();
  if (!texto) return dropdown.style.display = "none";

  COMUNAS_ACTIVAS
    .filter(c => c.toLowerCase().includes(texto))
    .forEach(nombre => {
      const d = document.createElement("div");
      d.className = "dropdown-item";
      d.textContent = nombre;
      d.onclick = () => {
        input.value = nombre;
        dropdown.style.display = "none";
        irAComuna(nombre);
      };
      dropdown.appendChild(d);
    });

  dropdown.style.display = "block";
});
</script>

</body>
</html>
