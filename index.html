<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Flete por Comuna – Región Metropolitana</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: white;
}

#map {
  width: 100vw;
  height: 100vh;
  background: white;
}

.info {
  position: absolute;
  bottom: 20px;
  left: 20px;
  background: white;
  padding: 12px 16px;
  font-family: Arial, sans-serif;
  font-size: 15px;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  z-index: 999;
}

.label-comuna {
  font-size: 11px;
  font-weight: bold;
  color: #333;
  background: transparent;
  border: none;
  box-shadow: none;
}
</style>
</head>

<body>

<div id="map"></div>
<div class="info" id="info">
  Pase el mouse sobre una comuna
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ===============================
   CONFIGURACIÓN GENERAL
================================ */

const FLETE_BASE = 7000;

// Comunas activas (Zona A)
const COMUNAS_ACTIVAS = [
  "Cerrillos","Cerro Navia","Conchalí","El Bosque","Estación Central",
  "Huechuraba","Independencia","La Cisterna","La Florida","La Granja",
  "La Pintana","La Reina","Lampa","Las Condes","Lo Barnechea","Lo Espejo",
  "Lo Prado","Macul","Maipú","Ñuñoa","Pedro Aguirre Cerda","Peñalolén",
  "Providencia","Pudahuel","Puente Alto","Quilicura","Quinta Normal",
  "Recoleta","Renca","San Bernardo","San Joaquín","San Miguel",
  "San Ramón","Santiago","Vitacura"
];

// Colores alternados
const colores = [
  "#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3",
  "#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd",
  "#ccebc5","#ffed6f"
];

// Crear mapa
const map = L.map('map', {
  zoomControl: true,
  minZoom: 10,
  maxZoom: 13,
  dragging: true,
  scrollWheelZoom: true,
  doubleClickZoom: true,
  boxZoom: false,
  keyboard: false
}).setView([-33.45, -70.66], 10);

// Limitar área RM
map.setMaxBounds([
  [-34.2, -71.6],
  [-32.8, -69.9]
]);

/* ===============================
   AUTOPISTA AMÉRICO VESPUCIO
================================ */

const americoVespucioCoords = [
  [-33.356, -70.670],
  [-33.370, -70.700],
  [-33.395, -70.720],
  [-33.430, -70.730],
  [-33.455, -70.735],
  [-33.470, -70.730],
  [-33.490, -70.720],
  [-33.520, -70.710],
  [-33.550, -70.700],
  [-33.575, -70.680],
  [-33.590, -70.660],
  [-33.585, -70.620],
  [-33.560, -70.590],
  [-33.525, -70.575],
  [-33.500, -70.575],
  [-33.470, -70.585],
  [-33.430, -70.600],
  [-33.390, -70.625],
  [-33.356, -70.670]
];

const americoVespucio = L.polyline(americoVespucioCoords, {
  color: "red",
  weight: 4,
  opacity: 0.9
}).addTo(map);

americoVespucio.bindTooltip("Autopista Américo Vespucio", {
  permanent: true,
  direction: "center",
  className: "label-comuna"
});

/* ===============================
   FUNCIONES
================================ */

function estilo(feature) {
  const index = feature.properties.OBJECTID % colores.length;
  return {
    fillColor: colores[index],
    weight: 1,
    color: "#555",
    fillOpacity: 0.85
  };
}

function resaltar(e) {
  const layer = e.target;
  layer.setStyle({
    weight: 3,
    color: "#000",
    fillOpacity: 1
  });

  const nombre =
    layer.feature.properties.NOM_COM ||
    layer.feature.properties.COMUNA ||
    "Comuna";

  document.getElementById("info").innerHTML =
    `<strong>${nombre}</strong><br>Flete: $${FLETE_BASE.toLocaleString("es-CL")}`;
}

function resetear(e) {
  geojson.resetStyle(e.target);
  document.getElementById("info").innerHTML =
    "Pase el mouse sobre una comuna";
}

/* ===============================
   CARGA COMUNAS RM
================================ */

let geojson;

fetch("https://services3.arcgis.com/uZrwedu11XCCdHk1/ArcGIS/rest/services/Comunas_de_la_RM/FeatureServer/1/query?where=1=1&outFields=*&f=geojson")
  .then(r => r.json())
  .then(data => {

    geojson = L.geoJSON(data, {
      filter: function (feature) {
        const nombre =
          feature.properties.NOM_COM ||
          feature.properties.COMUNA ||
          "";
        return COMUNAS_ACTIVAS.includes(nombre);
      },
      style: estilo,
      onEachFeature: function (feature, layer) {

        const nombre =
          feature.properties.NOM_COM ||
          feature.properties.COMUNA ||
          "";

        layer.bindTooltip(nombre, {
          permanent: true,
          direction: "center",
          className: "label-comuna"
        });

        layer.on({
          mouseover: resaltar,
          mouseout: resetear
        });
      }
    }).addTo(map);

    map.fitBounds(geojson.getBounds());

  })
  .catch(err => {
    document.getElementById("info").innerHTML =
      "Error cargando comunas RM";
    console.error(err);
  });
</script>

</body>
</html>
